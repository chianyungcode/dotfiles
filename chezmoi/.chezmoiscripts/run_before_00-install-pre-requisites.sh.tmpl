#!/usr/bin/env bash

{{ template "shared_script_utils.bash" . }}

{{ if eq .chezmoi.os "darwin" }}

if [[ ! $(command -v brew) ]]; then
    header "🍺  Installing Homebrew"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

if [[ -e "/opt/homebrew/bin/brew" && ! $(command -v brew) ]]; then
    notice "Adding Homebrew to your PATH"

    # Check if .zprofile exists, create if it doesn't
    if [[ ! -f "/Users/{{ .chezmoi.username }}/.zprofile" ]]; then
        notice "Creating .zprofile file"
        touch "/Users/{{ .chezmoi.username }}/.zprofile"
    fi

    echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >>/Users/{{ .chezmoi.username }}/.zprofile
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

{{ end }}

{{ if eq .chezmoi.os "linux" }}

install=false

# Declare a regular array for the package names
declare -a packages=(
    "curl"
    "unzip"
    "wget"
)

to_install=()

# Loop through the commands to check if they're installed
for cmd in "${packages[@]}"; do
    if ! command -v "${cmd}" &>/dev/null; then
        install=true
        to_install+=("${cmd}")
    fi
done

# Install missing packages based on distribution
if ${install}; then
    {{ if eq .chezmoi.osRelease.id "arch" }}
    # Arch Linux
    header "Updating package list"
    sudo pacman -Sy

    for pkg in "${to_install[@]}"; do
        header "Installing ${pkg}"
        sudo pacman -S --noconfirm "${pkg}"
    done

    # Install packages required for paru AUR helper
    header "Installing packages required for paru AUR helper"
    sudo pacman -S --needed --noconfirm git base-devel

    # Install paru AUR helper
    header "Installing paru AUR helper"
    # Check if paru is already installed
    if ! command -v paru &>/dev/null; then
        # Clone paru repository
        cd /tmp || exit 1
        git clone https://aur.archlinux.org/paru.git
        cd paru || exit 1

        # Build and install paru
        makepkg -si --noconfirm

        # Clean up
        cd /tmp || exit 1
        rm -rf paru

        # Verify installation
        if command -v paru &>/dev/null; then
            success "paru AUR helper installed successfully"
        else
            error "Failed to install paru AUR helper"
            exit 1
        fi
    else
        info "paru is already installed"
    fi

    {{ else if eq .chezmoi.osRelease.id "ubuntu" "debian" }}
    # Ubuntu/Debian
    header "Updating package list"
    sudo apt update

    for pkg in "${to_install[@]}"; do
        header "Installing ${pkg}"
        sudo apt install -y "${pkg}"
    done
    {{ else }}
    echo "Distribution Linux {{ .chezmoi.osRelease.id }} tidak didukung"
    exit 1
    {{ end }}
fi

{{ end }}

_safeExit_
