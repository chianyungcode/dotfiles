{{- if and (eq .chezmoi.os "linux") (.dev_computer) (eq .chezmoi.arch "amd64" ) (not .is_ci_workflow) -}}
#!/usr/bin/env bash

{{ template "shared_script_utils.bash" . }}

_hasJQ_ # Confirm we have jq installed

VERBOSE=false
PACKAGE_NAME="git credential manager"
REPOSITORY="git-ecosystem/git-credential-manager"

header "Verify ${PACKAGE_NAME} installation and check for updates"

# Fetch the API response once and store it in a variable (capture HTTP status)
if [[ -n "${GITHUB_TOKEN:-}" ]]; then
    API_RAW=$(curl -sL \
        -H "Authorization: token ${GITHUB_TOKEN}" \
        -w "\n%{http_code}" \
        "https://api.github.com/repos/${REPOSITORY}/releases/latest")
else
    API_RAW=$(curl -sL \
        -w "\n%{http_code}" \
        "https://api.github.com/repos/${REPOSITORY}/releases/latest")
fi

API_RESPONSE="$(echo "${API_RAW}" | sed '$d')"
HTTP_STATUS="$(echo "${API_RAW}" | tail -n1)"

if [[ "${HTTP_STATUS}" != "200" ]]; then
    fatal "GitHub API request failed with status ${HTTP_STATUS}. Response: $(echo "${API_RESPONSE}" | head -c 200)"
fi

if ! echo "${API_RESPONSE}" | jq -e . >/dev/null 2>&1; then
    fatal "GitHub API returned non-JSON response. Response: $(echo "${API_RESPONSE}" | head -c 200)"
fi

# Extract the required information from the stored API response
LATEST_VERSION=$(echo "${API_RESPONSE}" | jq -r .tag_name | sed 's/v//g')
IS_PRE_RELEASE=$(echo "${API_RESPONSE}" | jq -r .prerelease)
IS_DRAFT=$(echo "${API_RESPONSE}" | jq -r .draft)
RELEASE_NOTES=$(echo "${API_RESPONSE}" | jq -r .html_url)

info "Latest version is ${LATEST_VERSION}"
debug "Is pre-release: ${IS_PRE_RELEASE}"
debug "Is draft: ${IS_DRAFT}"
debug "Release Notes: ${RELEASE_NOTES}"

if git credential-manager --version &>/dev/null; then
  CURRENT_VERSION=$(git credential-manager --version | grep -Po '\d+\.\d+\.\d+')

    info "Local version: ${CURRENT_VERSION}"

    if [[ ${CURRENT_VERSION} == "${LATEST_VERSION}" ]]; then
        success "${PACKAGE_NAME} is already up to date"
        _safeExit_ 0
    fi

    if [[ ${IS_PRE_RELEASE} == "true" ]] || [[ ${IS_DRAFT} == "true" ]]; then
        notice "Latest version is a pre-release or draft. Skipping update."
        _safeExit_ 0
    fi
fi

_makeTempDir_ "$(basename "$0")"
pushd "${TMP_DIR}" &>/dev/null || exit

ARCH="{{.chezmoi.arch }}"
ARCH_REGEX="${ARCH}"
if [[ "${ARCH}" == "amd64" ]]; then
    ARCH_REGEX="(amd64|x64)"
elif [[ "${ARCH}" == "arm64" ]]; then
    ARCH_REGEX="(arm64|aarch64)"
fi

DEB_URL="$(echo "${API_RESPONSE}" | jq -r --arg re "${ARCH_REGEX}" '
    .assets[]
    | select(.name | test("deb$"; "i"))
    | select(.name | test("linux"; "i"))
    | select(.name | test($re; "i"))
    | .browser_download_url
' | head -n1)"
if [[ -z "${DEB_URL}" || "${DEB_URL}" == "null" ]]; then
    fatal "No Linux .deb asset found for arch ${ARCH} in latest release"
fi

DEB="$(basename "${DEB_URL}")"

WGETRC=/dev/null wget --no-config --hsts-file='{{ .xdgDataDir }}/wget-hsts' "${DEB_URL}"
sudo dpkg -i "${DEB}"
rm "${DEB}"

success "${PACKAGE_NAME} v${LATEST_VERSION} installed"
info "Release notes: ${RELEASE_NOTES}"

popd &>/dev/null || exit
_safeExit_
{{ end }}
