#!/usr/bin/env bash

# Set TERM for CI/CD environments
export TERM=${TERM:-dumb}

# Source shared script utilities
{{ template "shared_script_utils.bash" . }}

header "Installing proto - Language version manager"

# Install proto - Universal version manager
# Based on official installation: https://moonrepo.dev/docs/proto/install
if command -v proto >/dev/null 2>&1; then
    info "proto is already installed."
    PROTO_VERSION=$(proto --version 2>/dev/null | awk '{print $2}' || echo "unknown")
    info "Current proto version: $PROTO_VERSION"
else
    info "Installing proto..."
    if curl -fsSL https://moonrepo.dev/install/proto.sh | bash; then
        success "proto installed successfully"
        # Add proto to PATH for current session
        export PATH="$HOME/.proto/bin:$PATH"
    else
        error "Failed to install proto"
        exit 1
    fi
fi

# Verify proto is available
if ! command -v proto >/dev/null 2>&1; then
    error "proto command not found after installation"
    exit 1
fi

# Install node, go, and rust with error handling
header "Installing Node.js, Go, and Rust via proto"

LANGUAGES=("node" "go" "rust")
for lang in "${LANGUAGES[@]}"; do
    info "Installing $lang..."
    if proto install "$lang"; then
        success "$lang installed successfully"
    else
        error "Failed to install $lang"
    fi
done
